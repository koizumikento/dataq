name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always

jobs:
  verify:
    name: Verify
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt,clippy,llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Restore Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

      - name: Run tests
        run: cargo test --workspace --all-features -- --test-threads=1

      - name: Check coverage threshold
        run: cargo llvm-cov --workspace --all-features --fail-under-lines 80 --fail-under-regions 75

  build:
    name: Build (${{ matrix.target }})
    needs: verify
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            archive_ext: tar.gz
            bin: dataq
          - runner: windows-latest
            target: x86_64-pc-windows-msvc
            archive_ext: zip
            bin: dataq.exe
          - runner: macos-14
            target: x86_64-apple-darwin
            archive_ext: tar.gz
            bin: dataq
          - runner: macos-14
            target: aarch64-apple-darwin
            archive_ext: tar.gz
            bin: dataq
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Restore Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build release binary
        run: cargo build --release --locked --target ${{ matrix.target }}

      - name: Package archive (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"
          target="${{ matrix.target }}"
          archive="dataq-${tag}-${target}.${{ matrix.archive_ext }}"
          checksum="dataq-${tag}-${target}.sha256"
          package_dir="dist/dataq-${tag}-${target}"

          mkdir -p "${package_dir}"
          cp "target/${target}/release/${{ matrix.bin }}" "${package_dir}/"
          cp LICENSE README.md "${package_dir}/"

          tar -C dist -czf "dist/${archive}" "dataq-${tag}-${target}"
          shasum -a 256 "dist/${archive}" > "dist/${checksum}"

      - name: Package archive (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $target = "${{ matrix.target }}"
          $archive = "dataq-$tag-$target.${{ matrix.archive_ext }}"
          $checksum = "dataq-$tag-$target.sha256"
          $packageDir = "dist/dataq-$tag-$target"

          New-Item -ItemType Directory -Path $packageDir -Force | Out-Null
          Copy-Item "target/$target/release/${{ matrix.bin }}" $packageDir
          Copy-Item "LICENSE", "README.md" $packageDir

          if (Test-Path "dist/$archive") {
            Remove-Item "dist/$archive" -Force
          }
          Compress-Archive -Path "$packageDir/*" -DestinationPath "dist/$archive"

          $hash = (Get-FileHash -Algorithm SHA256 "dist/$archive").Hash.ToLower()
          "$hash  $archive" | Out-File -FilePath "dist/$checksum" -Encoding ascii

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.target }}
          if-no-files-found: error
          path: |
            dist/dataq-${{ github.ref_name }}-${{ matrix.target }}.${{ matrix.archive_ext }}
            dist/dataq-${{ github.ref_name }}-${{ matrix.target }}.sha256

  release:
    name: Publish Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          prerelease: ${{ contains(github.ref_name, '-') }}
          files: |
            dist/*
